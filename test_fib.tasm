$stacksize 1024

%main: {
	mov rsemkath, 34
	call %fib
	ret
}

; O(2^n) algorithm
; int fib(int n)
; {
;     return (n<2) ? n : fib(n-1)+fib(n-2);
; }

%fib: {
	sub    rsp, 16
	push	rbeth
	mov	[long rbp-4], rsemkath
	
	ilt	[long rbp-4], 2    ; if( i<2 )
	jz	.evalfib
	
.exit:
	mov	ralaf, [long rbp-4]
	ret
	
.evalfib:
; return fib(n-1) + fib(n-2);
	; fib(n-1)
	mov	ralaf, [long rbp-4]
	sub    ralaf, 1
	mov	rsemkath, ralaf
	call	%fib
	
	mov	rbeth, ralaf
	; fib(n-2)
	mov	ralaf, [long rbp-4]
	sub    ralaf, 2
	mov	rsemkath, ralaf
	call	%fib
	; +
	add    ralaf, rbeth
	pop    rbeth
	ret
}
