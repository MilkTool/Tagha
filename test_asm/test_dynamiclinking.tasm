$global module_str "test_factorial.tbc"

$native tagha_module_new_from_file
$native tagha_module_link_module
$native tagha_module_free

$extern test_factorial@factorial

main: {
    alloc       10
    movi        r9, 10000000    ;; 1000000000 / 1000000 / 10000000
    
    ldvar       r0, module_str
    call        tagha_module_new_from_file
    mov         r8, r0
    
    mov         r1, r8
    movi        r0, 0
    call        tagha_module_link_module
    
    ; test dynamic linking function invocation overhead
    movi        r7, 1
    movi        r6, 0
.loop:
    movi        r1, 5    ;; rsp[1] = 5;
    movi        r0, 1    ;; rsp[0] = 1;
    call        test_factorial@factorial    ; factorial(5);
    sub         r9, r7
    cmp         r9, r6
    jz          .loop
    mov         r4, r0
    
    mov         r3, r8   ;; rsp[3] = rsp[8];
    lsp         r0, 24   ;; rsp[0] = &rsp[3];
    call        tagha_module_free ;; tagha_module_free(&module);
    mov         r9, r4
    redux       9
    ret
}