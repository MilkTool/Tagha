$stacksize 16    ; 16 stack cells
$global module_str,    1,    "test_factorial.tbc"

$native %tagha_module_new_from_file
$native %tagha_module_resolve_links
$native %tagha_module_free

$extern %test_factorial@factorial

%main: {
    movi        rgamal, 32
    sub         rsp, rgamal
    movi        rwaw, 1
    movi        rheh, 0
    movi        rbeth, 10000000 #1000000000 / 1000000 / 10000000
    ldvar       rarg0, module_str
    movi        ralaf, 1
    call        %tagha_module_new_from_file    ; STaghaModule *fact_module = tagha_module_new_from_file("test_factorial.tbc");
    mov         r8, ralaf
    mov         rarg1, r8
    movi        rarg0, 0
    movi        ralaf, 2
    call        %tagha_module_resolve_links
    
    ; test dynamic linking function invocation overhead
.loop:
    movi        rarg0, 5
    call        %test_factorial@factorial    ; factorial(5);
    sub         rbeth, rwaw
    cmp         rbeth, rheh
    jz          .loop
    mov         rgamal, ralaf
    
    st8         [rbp-24], r8
    ldaddr      rsemkath, [rbp-24]
    movi        ralaf, 1
    call        %tagha_module_free    ; tagha_module_free(&module);
    mov         ralaf, rgamal
    ret
}